<!DOCTYPE html>
<html>
<head>
	<title>Sharp Pair Game</title>
	<style type="text/css">
		.container {
			background-color: #99CCFF;
			border: thick solid #808080;
			padding: 20px;
			margin: 20px;
		}
		#preloader { 
			display: none;
		}
		#gameContainer {
			display: none;
		}
		#gameWait {
			display: none;
		}
		#gameArea {
			vertical-align: top;
			display: none;
			position: relative;
		}
		#gamePlayers {
			vertical-align: top;
			display: inline-block;
			margin-right: 10px;
		}
		#gameInvites {
			vertical-align: top;
			display: inline-block;
			margin-right: 10px;
		}
		.gamePlayer {
			display: block;
		}
		.gameInvite {
			display: block;
		}
		.gameCurPlayer {
			display: block;
		}
		#gameStop {
			position: absolute;
			cursor: pointer;
			right: 5px;
		}
    </style>
</head>
<body>
	<div class="container">
		<div id="preloader">Loading...</div>
		<div id="loginForm">
			<input type="text" id="loginName">
			<input type="text" id="loginGender" value="0">
			<input type="button" id="loginBtn" value="Login">
		</div>
		<div id="gameContainer">
			<div id="gamePlayers"></div><!--
			--><div id="gameInvites"></div><!--
			--><div id="gameArea">
					<div id="gameStop" title="Stop the Game">X</div>
					<div id="gameResult">Game messages home</div>
					<div id="gameQuestion">Question <b id="gameQuestionNum">1</b>: <b id="gameQuestionBody">here is the question body</b></div>
					<div id="gameWait">Waiting answer of other player</div>
					<div id="gameAnswers">
						<a data-id="1" class="gameAnswer" href="javascript:">Yes</a>&nbsp;
						<a data-id="2" class="gameAnswer" href="javascript:">No</a>&nbsp;
					</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">
	(function(webSoc, getById){
		var

		preloader = (function(getById){
			var proto = Preloader.prototype;

			function Preloader(el){
				this.el = el;
			}

			proto.show = function(){
				this.el.style.display = 'block';
			};

			proto.hide = function(){
				this.el.style.display = 'none';
			};

			return new Preloader(getById('preloader'));
		})(getById),

		ws = (function(ws){
			var proto = WS.prototype,

			onmessage = function(e){
				this.onmessage(JSON.parse(e.data));
			};

			function WS(ws){
				this.ws = ws;
				this.ws.onmessage = onmessage.bind(this);
			}

			proto.send = function(data){
				this.ws.send(JSON.stringify(data));
			};

			proto.onmessage = function(data){
				console.log(data);
			};

			return new WS(ws);
		})(webSoc),

		Game = (function(ws, getById){
			var proto = Game.prototype,

			invite = function(e){
				if (e.target.classList.contains('gamePlayer')) {
					ws.send({method: 'invite', id: e.target.id.substr(3)});
				}
			},

			startGame = function(e){
				if (e.target.classList.contains('gameInvite')) {
					ws.send({method: 'startGame', id: e.target.id.substr(4)});
				}
			},

			stopGame = function(e){
				this.area.style.display = 'none';
				if (this.playingId) {
					ws.send({method: 'stopGame'});
				}
			},

			answer = function(e){
				if (e.target.classList.contains('gameAnswer')) {
					ws.send({method: 'answer', answer: e.target.dataset.id});
					this.wait.style.display = 'block';
					this.answers.style.display = 'none';
				}
			},

			onmessage = function(data){
				this['on'+ data.method](data);
			};

			function Game(player, players){
				this.player = player;

				this.container = getById('gameContainer');
				this.players = getById('gamePlayers');
				this.invites = getById('gameInvites');

				this.area = getById('gameArea');
				this.stop = getById('gameStop');
				this.wait = getById('gameWait');
				this.result = getById('gameResult');
				this.answers = getById('gameAnswers');
				this.questionNum = getById('gameQuestionNum');
				this.questionBody = getById('gameQuestionBody');

				this.renderPlayers(players);
				this.container.style.display = 'block';
				this.stop.onclick = stopGame.bind(this);
				this.players.onclick = invite.bind(this);
				this.invites.onclick = startGame.bind(this);
				ws.onmessage = onmessage.bind(this);
			}

			proto.renderPlayers = function(players){
				var str = '';
				for (var player in players) {
					player = players[player];
					if (player.id == this.player.id) {
						str += '<span id="pl-'+ player.id +'" class="gameCurPlayer">'+ player.name +'</span>';
					} else {
						str += '<a href="javascript:" id="pl-'+ player.id +'" class="gamePlayer">'+ player.name +' ('+ player.gender +')'+'</a>';
					}
				}
				this.players.innerHTML = str + this.players.innerHTML;
			};

			proto.oninvite = function(data){
				if (data.error) {
					alert(data.error);
					return;
				}
				var existed = getById('inv-'+ data.player.id);
				if (existed) {
					existed.remove();
				}
				this.invites.innerHTML += '<a href="javascript:" id="inv-'+ data.player.id +'" class="gameInvite">'+ data.player.name +'</a>';
			};

			proto.onadd = function(data){
				if (this.player.id != data.player.id) {
					var player = {};
					player[data.player.id] = data.player;
					this.renderPlayers(player);
				}
			};

			proto.onremove = function(data){
				var 
				player = getById('pl-'+ data.player.id),
				invite = getById('inv-'+ data.player.id);

				player && player.remove();
				invite && invite.remove();

				if (data.player.id == this.playingId) {
					this.onstopGame();
				}
			};

			proto.onstartGame = function(data){
				if (data.error) {
					alert(data.error);
					return;
				}
				var invite = getById('inv-'+ data.player.id);
				invite && invite.remove();

				this.questionBody.textContent = data.question;
				this.result.textContent = 'Game messages home';
				this.questionNum.textContent = 1;
				this.area.style.display = 'inline-block';
				this.answers.onclick = answer.bind(this);

				this.playingId = data.player.id;
			};

			proto.onstopGame = function(){
				this.playingId = '';
				this.answers.onclick = null;
				this.result.textContent = 'User stoped game. Sorry.';
			};

			proto.onanswer = function(data){
				if (data.error) {
					alert(data.error);
					return;
				}
				this.result.textContent = 'User answered: '+ (data.answer == 1 ? 'Yes' : 'No');
				if (data.result) {
					this.answers.onclick = null;
					this.result.innerHTML += '<br>Game finished. You result: '+ data.result +'%';
					this.playingId = '';
				} else {
					var questionNum = parseInt(this.questionNum.textContent);
					this.questionNum.textContent = ++questionNum;
					this.questionBody.textContent = data.question;

					this.wait.style.display = 'none';
					this.answers.style.display = 'block';
				}
			};

			return Game;
		})(ws, getById),

		LoginForm = (function(ws, getById){
			var proto = LoginForm.prototype,

			login = function(){
				if (!this.loginName.value) {
					alert('Please put in name');
					return;
				}
				ws.send({method: 'login', name: this.loginName.value, gender: this.loginGender.value});
			},

			onLogedIn = function(data){
				if (data.players) {
					delete ws.onmessage;
					new Game(data.player, data.players);
					this.destroy();
				}
			};

			function LoginForm(){
				this.loginForm = getById('loginForm');
				this.loginName = getById('loginName');
				this.loginGender = getById('loginGender');
				this.loginBtn  = getById('loginBtn');

				this.loginBtn.onclick = login.bind(this);
				ws.onmessage = onLogedIn.bind(this);
			}

			proto.destroy = function(){
				this.loginForm.remove();
				delete this;
			};

			return LoginForm;
		})(ws, getById),

		loginForm = new LoginForm();
	})(new WebSocket('ws://192.168.56.101:8080/game'),
	// })(new WebSocket('ws://localhost:8080/game'),
		document.getElementById.bind(document));
    </script>
</body>
</html>